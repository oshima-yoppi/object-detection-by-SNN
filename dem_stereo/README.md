
# 本プログラムでできることの大まかな流れ


月面の障害物を検知するSNNを学習させるためのプログラム。以下の流れで行う。 
1. シミュレーション上で月面DEMを生成
2. Blenderで月面DEMをプロットし、アニメーションを行う。そしてカメラが月面に近づいていく様子の動画を作成する
3. V2Eを用いて動画からイベントデータに変換する。
4. 学習を行う
5. 学習結果を解析する

# フォルダ説明

- `akida`：brainchip関連。
- `blender`：blenderで生成されるデータセット。無視してよい
- `dataset`：データセット関連。シミュレーションによって作成されたデータが保存されていく。
- `models`：学習済みモデルが保存されている。
‐ `modules`：モジュール関連。モジュールをまとめている。かなり重要フォルダ。このフォルダ内で多くの関数や重要定数を定義している。
- `raw-data`：V2Eで変換したそのままのイベントデータが保存されている。(実際、SNNにこの生データを入力しない。時間窓に区切って入力する。)
- `result_img`：学習結果の画像が保存されている。
- `result_thesis`：論文で使用するための画像が保存されている。
- `thesis`：論文で使用するための画像が保存されている。


# 実験の進め方
1. DEM生成  
    - `create_dem.py`：DEMを生成する。フラクタルモデリングによって生成。クレータ生成と同時に安全危険領域のマッピングも行う。
2. Blenderでアニメーションを作成&カメラ視点のアノテーション
    - `new.blend`によってアニメーションを作成し、動画を保存する。(本ディレクトリdem内にあるblenderファイルを開かないと相対パス関連でエラーが出る可能性あり)ここでは同時にカメラ視点のアノテーションも行っている。
    - blender内部で`blender_make_video.py`のファイルを開き、スクリプト実行する。
    - 動画生成が開始される。その間,blenderは固まるけど気にしなくて大丈夫。
3. V2Eへの変換
    - `create_dataset.py`によって動画からイベントデータに変換する。この際、イベントの閾値を`module/const_base.json`ファイル内で設定する。
4. 設定と学習
    - 自分がSNNを学習する際、設定したいハイパーパラメータを`module/const_base.json`ファイル内で設定する。epoch数、閾値、リーク項、タイムステップ数、イベントをカウントするかどうかなど。
    - `train.py`：学習開始。この際、v2eで作成されたイベントのraw dataをイベントフレームへ変換する必要があるが、内部で勝手にやってくれる(詳細はコード見てください)。イベントフレーム変換が行われると`dataset`ディレクトリにイベントの閾値ごとでデータが保存される。
3. 解析  
    - `analysis.py`：学習結果を解析

# 実験の自動化
私はハイパーパラメータの影響を調査するため、多くの実験を行ったが、いちいち設定するのが非常に面倒だった。そのため、実験の自動化を行った。以下の手順で行う。
1. 実験したいハイパーパラメータを設定する  
    - `experiment_all.py`の中で、配列形式で、実験したいハイパーパラメータを設定する。例えば、`threshold = [0.1, 0.2, 0.3, 0.4, 0.5]`のように設定する。
2. 実験を行う
    - `experiment_all.py`を実行する。この際、`experiment_all.py`内で`train.py`と`analysis.py`を呼び出しているので、学習及び解析が行われる。そしてそれらの一連の結果はまとめて`result_experiment`ディレクトリに保存されていく。
3. 解析
    - リーク項の影響  
    学習が全て終わったら、`analysis_thesis_leaky.py`で結果を出力
    - 閾値の影響  
    `analysis_thesis_thresh.py`で結果を出力

4. その他ファイル説明
    - `akida-dataset.py`：brainchipのデータセットを作成するために使用。無視してよい
    <!-- - `model.py`：モデル定義   -->
    ‐ `data.py`: データローダー定義
    - `openh5.py`: h5ファイルの中身を確認＆`youtube`フォルダ内に動画を保存する
    - `fractal`：フラクタルモデリングするための関数ファイル・
    - `show_dem`：作成されたDEMをプロットするための関数ファイル。確認用。
    - `show_img_pertial`：[本物の月面DEM](https://www.isas.jaxa.jp/home/showcase/xR/kaguya-dem.html.ja)を確認するためファイル。実際の生データを表示させようとするとメモリえーらが発生するので、一部のみ表示する。

